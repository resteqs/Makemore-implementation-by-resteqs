digraph {
	rankdir=LR
	Xb [label=Xb]
	C [label=C]
	emb [label="emb = C[Xb]"]
	embcat [label="embcat = emb.view(...)"]
	W1 [label=W1]
	b1 [label=b1]
	hprebn [label="hprebn = embcat @ W1 + b1"]
	bnmeani [label="bnmeani = mean(hprebn)"]
	bndiff [label="bndiff = hprebn - bnmeani"]
	bndiff2 [label="bndiff2 = bndiff^2"]
	bnvar [label="bnvar = var(hprebn)"]
	bnvar_inv [label="bnvar_inv = (bnvar + 1e-5)^-0.5"]
	bnraw [label="bnraw = bndiff * bnvar_inv"]
	bngain [label=bngain]
	bnbias [label=bnbias]
	hpreact [label="hpreact = bngain * bnraw + bnbias"]
	tanh [label="h = tanh(hpreact)"]
	W2 [label=W2]
	b2 [label=b2]
	logits [label="logits = h @ W2 + b2"]
	logit_maxes [label="logit_maxes = logits.max(...)"]
	norm_logits [label="norm_logits = logits - logit_maxes"]
	counts [label="counts = exp(norm_logits)"]
	counts_sum [label="counts_sum = sum(counts)"]
	counts_sum_inv [label="counts_sum_inv = 1 / counts_sum"]
	probs [label="probs = counts * counts_sum_inv"]
	logprobs [label="logprobs = log(probs)"]
	loss [label="loss = -logprobs.mean()"]
	Xb -> emb [label="Embedding lookup"]
	C -> emb [label="Embedding matrix"]
	emb -> embcat [label=Flatten]
	embcat -> hprebn [label="Matrix multiply"]
	W1 -> hprebn [label=Weights]
	b1 -> hprebn [label=Bias]
	hprebn -> bnmeani [label=Mean]
	hprebn -> bndiff [label=Difference]
	bnmeani -> bndiff [label=Subtraction]
	bndiff -> bndiff2 [label=Square]
	bndiff2 -> bnvar [label=Variance]
	bnvar -> bnvar_inv [label="Inverse sqrt"]
	bnvar_inv -> bnraw [label=Scale]
	bndiff -> bnraw [label=Scale]
	bnraw -> hpreact [label="Shift and scale"]
	bngain -> hpreact [label=Gain]
	bnbias -> hpreact [label=Bias]
	hpreact -> tanh [label="Tanh activation"]
	tanh -> logits [label="Matrix multiply"]
	W2 -> logits [label=Weights]
	b2 -> logits [label=Bias]
	logits -> logit_maxes [label="Max for stability"]
	logit_maxes -> norm_logits [label="Subtract max"]
	logits -> norm_logits [label="Subtract max"]
	norm_logits -> counts [label=Exponentiate]
	counts -> counts_sum [label=Sum]
	counts_sum -> counts_sum_inv [label=Inverse]
	counts -> probs [label=Normalize]
	counts_sum_inv -> probs [label=Normalize]
	probs -> logprobs [label=Log]
	logprobs -> loss [label="Mean and negate"]
	grad_loss [label="dL/dloss" color=red shape=ellipse]
	loss -> grad_loss [label="Backward pass"]
	grad_logprobs [label="dL/dlogprobs" color=red shape=ellipse]
	grad_loss -> grad_logprobs [label="Backward pass"]
	grad_probs [label="dL/dprobs" color=red shape=ellipse]
	grad_logprobs -> grad_probs [label="Backward pass"]
	grad_counts_sum_inv [label="dL/dcounts_sum_inv" color=red shape=ellipse]
	grad_probs -> grad_counts_sum_inv [label="Backward pass"]
	grad_counts [label="dL/dcounts" color=red shape=ellipse]
	grad_probs -> grad_counts [label="Backward pass"]
	grad_counts_sum_inv -> grad_counts [label="Backward pass"]
	grad_norm_logits [label="dL/dnorm_logits" color=red shape=ellipse]
	grad_counts -> grad_norm_logits [label="Backward pass"]
	grad_logits [label="dL/dlogits" color=red shape=ellipse]
	grad_norm_logits -> grad_logits [label="Backward pass"]
	grad_tanh [label="dL/dtanh" color=red shape=ellipse]
	grad_logits -> grad_tanh [label="Backward pass"]
	grad_hpreact [label="dL/dhpreact" color=red shape=ellipse]
	grad_tanh -> grad_hpreact [label="Backward pass"]
	grad_bnraw [label="dL/dbnraw" color=red shape=ellipse]
	grad_hpreact -> grad_bnraw [label="Backward pass"]
	grad_bndiff [label="dL/dbndiff" color=red shape=ellipse]
	grad_bnraw -> grad_bndiff [label="Backward pass"]
	grad_bnvar_inv [label="dL/dbnvar_inv" color=red shape=ellipse]
	grad_bnraw -> grad_bnvar_inv [label="Backward pass"]
	grad_bnvar [label="dL/dbnvar" color=red shape=ellipse]
	grad_bnvar_inv -> grad_bnvar [label="Backward pass"]
	grad_bndiff2 [label="dL/dbndiff2" color=red shape=ellipse]
	grad_bnvar -> grad_bndiff2 [label="Backward pass"]
	grad_bndiff2 -> grad_bndiff [label="Backward pass"]
	grad_bndiff -> grad_hprebn [label="Backward pass"]
	grad_hprebn -> bnmeani [label="Backward pass"]
	grad_hprebn -> hprebn [label="Backward pass"]
	grad_embcat [label="dL/dembcat" color=red shape=ellipse]
	grad_hprebn -> grad_embcat [label="Backward pass"]
	grad_emb [label="dL/demb" color=red shape=ellipse]
	grad_embcat -> grad_emb [label="Backward pass"]
	grad_Xb [label="dL/dXb" color=red shape=ellipse]
	grad_emb -> grad_Xb [label="Backward pass"]
	dpi=300
}
